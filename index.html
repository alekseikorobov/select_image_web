<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>select images</title>
  <style>
    #body {
      margin: 0 auto;
      text-align: center;
    }

    .status_bar {
      display: flex;
      justify-content: center;
      align-items: center;
    }

    #is_selected {
      width: 200px;
      display: inline-block;
    }
    #list_hotel,#list_tags{
      display: inline-block;
      vertical-align: top;
      /* width: 350px; */
      text-align: justify;
      height: 450px;
      overflow-y: auto;
    }
    #list_hotel{
      width: 350px;
    }
    #list_tags{
      width: 170px;
    }
    .good_selected{
      color: green;
    }
  </style>
  <script src="images_all.js"></script>
</head>

<body id="body">
  <div class="status_bar">
    <div style="display: inline-block;">
      <label for="assigne">Выбрать исполнителя</label>
      <select id="assigne" onchange="on_select_assigne(this)">
        <option value=""></option>
        <option value="Влад">Влад</option>
        <option value="Даниил">Даниил</option>
        <option value="Леша">Леша</option>
        <option value="Максим">Максим</option>
        <option value="Настя">Настя</option>
        <option value="Оля">Оля</option>
      </select>
    </div>
    <div style="display: inline-block;">
      <p id="is_selected"></p>
    </div>
  </div>
  
  
  <p id="title"></p>
  
  
  <div>
    <div id="list_hotel"></div>
    <div id="list_tags"></div>
    <img id="image" style="width: 600px;display: inline-block;"/>
  </div>
  <br/>

  <div id="main" style="display: none;">
    <p id="result"></p>
    <button onclick="save_to_file()">Donwlod</button>
    <button onclick="clear_cache()">Clear Cache</button>
    <p style="color: gray;">Листать стрелками, цифра 1 для выбора</p>
  </div>

</body>

<script>
  let image_element = document.getElementById('image')
  let body_element = document.getElementById('body')
  let is_selected_element = document.getElementById('is_selected')
  let title_element = document.getElementById('title')
  let result_element = document.getElementById('result')
  let list_hotel_element = document.getElementById('list_hotel')
  let list_tag_element = document.getElementById('list_tags')
  let main_element = document.getElementById('main')
  let assigne_element = document.getElementById('assigne')



  function save_to_file() {
    const rows = [
      //["name1", "city1", "some other info"],
      //["name2", "city2", "more info"]
    ];

    for (const obj_select of images_assigne.filter((e) => e.selected)) {
      ////console.log(obj_select)
      rows.push([obj_select.url])
    }

    let csvContent = "data:text/csv;charset=utf-8,"
      + rows.map(e => e.join(",")).join("\n");

    var encodedUri = encodeURI(csvContent);
    window.open(encodedUri);

    var encodedUri = encodeURI(csvContent);
    var link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", "my_data.csv");
    document.body.appendChild(link); // Required for FF

    //link.click(); // This will download the data file named "my_data.csv".
  }

  for(const obj of images_all){
    obj.key = obj.city+'____'+obj.transaction_info_norm
    if(obj.tag_name == '') {
      obj.tag_name = 'Прочее'
    }
    obj.key_tag = obj.city+'____'+obj.transaction_info_norm+'____'+obj.tag_name
  }

  let images_assigne = []
  let images_hotels = []
  let images_tags = []
  let list_hotels = []
  let list_tags = []
  let list_hotels_a_elemens = []
  let list_tags_a_elemens = []
  let curr_selected_hotel = null
  let curr_selected_hotel_index = null
  result_element.innerHTML = 'Выбрано - 0'
  let selected_image_ids = []
  let curr_selected_tag = null;
  let curr_selected_tag_index = null


  function clear(){
    images_assigne = []
    images_hotels = []
    list_hotels_a_elemens = []
    curr_selected_hotel = null
    curr_selected_hotel_index = null

    image_element.removeAttribute('src')
    is_selected_element.innerHTML = null
    title_element.innerHTML = null
    result_element.innerHTML = null
    main_element.style="display: none;"
    result_element.innerHTML = 'Выбрано - 0'
  }


  function select_tag(obj,key_tag,index){
    if(curr_selected_tag != null){
      curr_selected_tag.style=''
    }
    curr_selected_tag_index = index
    obj.style='font-weight: bold;'
    curr_selected_tag = obj
    
    images_tags = images_assigne.filter(e=>e.key_tag == key_tag)
    
    //init_tags()
    curr_index = 0
    show_image(curr_index)
  }
  function select_tag_by_index(index){
    select_tag(list_tags_a_elemens[index],list_tags[index].key,index)
  }

  function show_tag_list(){
    list_tag_element.innerHTML = ''
    index = 0
    for(const tag_obj of list_tags){
      let text = `${tag_obj.tag} ( ${tag_obj.selected_count} /  ${tag_obj.all_count})`;
      let class_name = ''

      list_tag_element.innerHTML += `<a href='#' class='${class_name}' onclick="select_tag(this,'${tag_obj.key}',${index})">${text}</a><br>`
      index++
    }

    list_tags_a_elemens = list_tag_element.querySelectorAll('a')

    if(list_tags.length>0){
      select_tag_by_index(0)
    }
  }
  function init_tags(){
    list_tags = []
    let tag_groups = Object.groupBy(images_hotels, ({ key_tag }) => key_tag)
    for (const key of Object.keys(tag_groups)) {
      const elements = tag_groups[key];
      let city = key.split('____')[0]
      let hotel = key.split('____')[1]
      let tag = key.split('____')[2]
      list_tags.push({
        key:key,
        city:city,
        hotel:hotel,
        tag:tag,
        all_count:elements.length,
        selected_count:elements.filter(e=>e.selected).length,
        is_active:false
      })
    }
    show_tag_list()
  }

  function select_hotel(obj, key, index){
    if(curr_selected_hotel != null){
      curr_selected_hotel.style=''
    }
    curr_selected_hotel_index = index
    obj.style='font-weight: bold;'
    curr_selected_hotel = obj
    
    images_hotels = images_assigne.filter(e=>e.key == key)
    
    init_tags()
  }
  
  function select_hotel_by_index(index){
    select_hotel(list_hotels_a_elemens[index],list_hotels[index].key,index)
  }
  
  function show_hotel_list(){
    list_hotel_element.innerHTML = ''
    index = 0
    for(const hotel_obj of list_hotels){
      let text = `${hotel_obj.city} ${hotel_obj.hotel} ( ${hotel_obj.selected_count} /  ${hotel_obj.all_count})`
      let class_name = ''
      if (hotel_obj.selected_count>=10){
        class_name = 'good_selected'
      }

      list_hotel_element.innerHTML += `<a href='#' class='${class_name}' onclick="select_hotel(this,'${hotel_obj.key}',${index})">${text}</a><br>`
      index++
    }

    list_hotels_a_elemens = list_hotel_element.querySelectorAll('a')

    if(list_hotels.length>0){

      select_hotel_by_index(0)
    }
    else{
      list_hotel_element.innerHTML = 'нет картинок'
      clear()
    }
  }

  function init_hotels(){
    list_hotels = []
    let hotel_groups = Object.groupBy(images_assigne, ({ key }) => key)
    for (const key of Object.keys(hotel_groups)) {
      const elements = hotel_groups[key];
      let city = key.split('____')[0]
      let hotel = key.split('____')[1]
      list_hotels.push({
        key:key,
        city:city,
        hotel:hotel,
        all_count:elements.length,
        selected_count:elements.filter(e=>e.selected).length,
        is_active:false
      })
    }
    show_hotel_list()
  }

  function select_assigne(assigne_name) {
    main_element.style = ''
    for(const key of Object.keys(assigne_element)){
      if(assigne_element[key].value == assigne_name){
        assigne_element[key].selected = true
      }
    }
    images_assigne = images_all.filter(e => e.assigne == assigne_name)
    init_hotels()
  }
  function on_select_assigne(e) {
    const assigne_name = e[e.selectedIndex].value;
    if (assigne_name != '') {
      
      assigne_element.blur(); //снять фокус, чтобы горячие клавишы работали
      select_assigne(assigne_name)
      save_assigne(assigne_name)
    }
  }

  function show_image(index) {
    let obj = images_tags[index]
    image_element.src = obj.url
    title_element.innerHTML = (index + 1).toString() + ' / ' + images_tags.length.toString() + '  ' + obj.city + ' (' + obj.tag_name + ') ' + obj.transaction_info_norm
    if (obj.selected == true) {
      is_selected_element.innerHTML = 'Выбрано'
      is_selected_element.style = 'color:green'
    } else {
      is_selected_element.innerHTML = 'не выбрано'
      is_selected_element.style = 'color:groy'
    }
  }
  
  function mark_select(index) {
    images_tags[index].selected = !images_tags[index].selected
    
    let hotel_obj = list_hotels[curr_selected_hotel_index]
    hotel_obj.selected_count = images_hotels.filter((e) => e.selected).length
    curr_hotels_a_elemens = list_hotels_a_elemens[curr_selected_hotel_index]
    curr_hotels_a_elemens.text = `${hotel_obj.city} ${hotel_obj.hotel} ( ${hotel_obj.selected_count} /  ${hotel_obj.all_count})`


    let tag_obj = list_tags[curr_selected_tag_index]
    tag_obj.selected_count = images_tags.filter((e) => e.selected).length
    curr_tags_a_elemens = list_tags_a_elemens[curr_selected_tag_index]
    curr_tags_a_elemens.text =`${tag_obj.tag} ( ${tag_obj.selected_count} /  ${tag_obj.all_count})`;
    
    if (hotel_obj.selected_count>=10){
      curr_hotels_a_elemens.classList.add('good_selected');
    } else if(curr_hotels_a_elemens.classList.contains('good_selected')){
      curr_hotels_a_elemens.classList.remove('good_selected');
    }
    result_element.innerHTML = 'Выбрано - ' + images_assigne.filter((e) => e.selected).length

    selected_image_ids = images_assigne.filter((e) => e.selected).map(e=>e.id)
    //console.log(selected_images)

    save_selected_images()

    show_image(index)
  }

  function onkeyup(e) {
    if (e.key == 'ArrowLeft') {
      if (curr_index > 0) {
        curr_index--;
      }
      show_image(curr_index)
    }
    else if (e.key == 'ArrowRight') {
      if (curr_index < images_hotels.length - 1) {
        curr_index++;
      }
      show_image(curr_index)
    }
    else if (e.key == 'ArrowDown') {
      
      if(curr_selected_tag_index<list_tags.length-1){
        curr_selected_tag_index++
        select_tag_by_index(curr_selected_tag_index)
      }
      else if(curr_selected_hotel_index < list_hotels.length-1){
        curr_selected_hotel_index++;
        select_hotel_by_index(curr_selected_hotel_index)
      }
    }
    else if (e.key == 'ArrowUp') {
      if(curr_selected_tag_index>0){
        curr_selected_tag_index--;
        select_tag_by_index(curr_selected_tag_index)
      }
      else if(curr_selected_hotel_index>0){ 
        curr_selected_hotel_index--;
        select_hotel_by_index(curr_selected_hotel_index)
      }
    }
    else if (e.key == '1') {
      mark_select(curr_index)
    } else {
      //console.log(e)
    }
  }

  body_element.addEventListener("keyup", onkeyup);


  window.onload = on_load_page

  function save_assigne(assigne_name){
    localStorage.setItem('assigne_name',assigne_name)
  }
  function save_selected_images(){
    localStorage.setItem('selected_image_ids',selected_image_ids) 
  }

  function mark_select_all_images(){
    for (const obj of images_all) {
      if(selected_image_ids.indexOf(obj.id)!=-1){
        obj.selected = true
      }
    }
  }

  function clear_cache(){
    if(confirm('сейчас весь кеш очиститься, все выбранные фотки и весь труд, точно хотите?')){
      localStorage.clear()
      clear()
    }
  }

  function on_load_page(){
    //зазрузить id с выделенными картинками 
    let _selected_image_ids = localStorage.getItem('selected_image_ids')
    if(_selected_image_ids != null){
      selected_image_ids = _selected_image_ids
      result_element.innerHTML = `Выбрано - ${selected_image_ids.length}`
      mark_select_all_images()
    }

    //загрузить из сессии пользователя
    let assigne_name = localStorage.getItem('assigne_name')
    if(assigne_name != null){
      select_assigne(assigne_name)
    }
  }
</script>

</html>